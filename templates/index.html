{% extends "base.html" %}
{% block content %}
<h2>Generate Promo Kit</h2>
<form id="promo-form" enctype="multipart/form-data">
    <input type="text" name="book_title" placeholder="Book Title (Required)" required>
    <input type="text" name="subtitle" placeholder="Subtitle (Optional)">
    <input type="text" name="author_name" placeholder="Author Name">
    <select name="genre">
        <option value="fiction">Fiction</option>
        <option value="non-fiction">Non-Fiction</option>
        <option value="romance">Romance</option>
        <option value="thriller">Thriller</option>
        <option value="scifi">Sci-Fi</option>
    </select>
    <textarea name="description" placeholder="Book Description" rows="5"></textarea>
    <input type="text" name="audience" placeholder="Target Audience">
    <input type="number" step="0.01" name="price" placeholder="Price">
    <select name="discounted">
        <option value="no">Is Discounted? No</option>
        <option value="yes">Is Discounted? Yes</option>
    </select>
    <input type="file" name="cover" accept="image/*">
    <select name="tone">
        <option value="dramatic">Dramatic</option>
        <option value="romantic">Romantic</option>
        <option value="bold">Bold</option>
        <option value="inspirational">Inspirational</option>
        <option value="dark">Dark</option>
    </select>
    <button type="submit" id="submit-btn">Generate Promo Kit</button>
</form>

<div id="results" style="display:none; margin-top: 2rem;">
    <h3>Generation Complete!</h3>
    <p>Tokens Used: <span id="tokens-count"></span></p>
    <p>Estimated Cost: $<span id="cost-amount"></span></p>
    <a id="download-link" href="#" style="display:inline-block; background: var(--accent); color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px;">Download ZIP</a>
</div>

<script>
document.getElementById('promo-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    showMessage('Generating promo kit... please wait.', 'loading');
    
    const formData = new FormData(e.target);
    const resp = await fetch('/generate', { method: 'POST', body: formData });
    const data = await resp.json();
    
    if (data.task_id) {
        pollStatus(data.task_id);
    } else {
        showMessage('Error starting generation.', 'error');
        btn.disabled = false;
    }
};

async function pollStatus(taskId) {
    const interval = setInterval(async () => {
        const resp = await fetch(`/status/${taskId}`);
        const data = await resp.json();
        if (data.status === 'completed') {
            clearInterval(interval);
            showMessage('Promo kit generated successfully!', 'success');
            document.getElementById('tokens-count').textContent = data.tokens;
            document.getElementById('cost-amount').textContent = data.cost;
            document.getElementById('download-link').href = data.download_url;
            document.getElementById('results').style.display = 'block';
            document.getElementById('submit-btn').disabled = false;
        } else if (data.status === 'failed') {
            clearInterval(interval);
            showMessage('Generation failed.', 'error');
            document.getElementById('submit-btn').disabled = false;
        }
    }, 2000);
}
</script>
{% endblock %}
